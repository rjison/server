{{ define "create" }}
{{ template "base" . }}
{{ end }}
{{ define "title" }}{{ t .Localizer "New Tronbyt Device" }}{{ end }}
{{ define "header" }}
<link rel="stylesheet" href="/static/css/update-simple.css">
<script src="/static/js/location.js"></script>
<div class="header-container">
    <h1 class="page-title">{{ t .Localizer "New Tronbyt Device" }}</h1>
</div>
<script>
    function setBrightnessCreate(brightness) {
        document.getElementById('brightness').value = brightness;
        document.getElementById('brightness-output').innerText = brightness;
        const buttons = document.querySelectorAll('#brightness-panel .brightness-btn');
        buttons.forEach(btn => {
            if (parseInt(btn.dataset.brightness) === parseInt(brightness)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
</script>
{{ end }}
{{ define "content" }}
<form method="post" id="create-device-form">
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Basic Information" }}</h2>
        <div class="device-settings-row">
            <div>
                <label for="name" class="device-settings-label">{{ t .Localizer "Name" }}</label>
                <input name="name"
                       id="name"
                       value="{{ .Form.Name }}"
                       required
                       class="device-settings-input">
                <small class="small-text">{{ t .Localizer "Descriptive name for this Tronbyt device" }}</small>
            </div>
            <div>
                <label for="device_type" class="device-settings-label">{{ t .Localizer "Device Type" }}</label>
                <select name="device_type" id="device_type" class="device-settings-input">
                    {{ $deviceType := .Form.DeviceType }}
                    {{ range .DeviceTypeChoices }}
                    <option value="{{ .Value.Slug }}"
                            {{ if eq $deviceType .Value.Slug }}
                            selected
                            {{ end }}>
                        {{ .Label }}
                    </option>
                    {{ end }}
                </select>
            </div>
        </div>
        <div class="device-settings-row">
            <div>
                <label class="device-settings-label">{{ t .Localizer "Device ID Mode" }}</label>
                <div style="display:flex;gap:16px;margin-bottom:8px;flex-wrap:wrap">
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="radio"
                               name="device_id_mode"
                               value="from_name"
                               {{ if eq .Form.DeviceIDMode "from_name" }}
                               checked
                               {{ end }}
                               onchange="updateDeviceIDMode()">
                        {{ t .Localizer "From Name" }}
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="radio"
                               name="device_id_mode"
                               value="hex8"
                               {{ if or (eq .Form.DeviceIDMode "hex8") (eq .Form.DeviceIDMode "") }}
                               checked
                               {{ end }}
                               onchange="updateDeviceIDMode()">
                        {{ t .Localizer "8-char hex" }}
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="radio"
                               name="device_id_mode"
                               value="hex16"
                               {{ if eq .Form.DeviceIDMode "hex16" }}
                               checked
                               {{ end }}
                               onchange="updateDeviceIDMode()">
                        {{ t .Localizer "16-char hex" }}
                    </label>
                </div>
                <label for="device_id" class="device-settings-label">
                    {{ t .Localizer "Device ID" }} ({{ t .Localizer "Optional" }})
                </label>
                <input name="device_id"
                       id="device_id"
                       value="{{ .Form.DeviceID }}"
                       class="device-settings-input"
                       placeholder="{{ if eq .Form.DeviceIDMode "from_name" }}{{ t .Localizer "Auto-generated from name" }}{{ else }}{{ t .Localizer "Leave blank to auto-generate" }}{{ end }}">
                <small class="small-text">{{ t .Localizer "Leave blank to auto-generate." }}</small>
            </div>
        </div>
    </div>
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Connection URLs" }}</h2>
        <div class="device-settings-row">
            <div>
                <label for="img_url" class="device-settings-label">{{ t .Localizer "Image URL" }}</label>
                <input name="img_url"
                       id="img_url"
                       value="{{ .Form.ImgURL }}"
                       class="device-settings-input">
                <small class="small-text">{{ t .Localizer "Leave blank unless advanced user." }}</small>
            </div>
            <div>
                <label for="ws_url" class="device-settings-label">{{ t .Localizer "WebSocket URL" }}</label>
                <input name="ws_url"
                       id="ws_url"
                       value="{{ .Form.WsURL }}"
                       class="device-settings-input">
                <small class="small-text">{{ t .Localizer "Leave blank unless advanced user." }}</small>
            </div>
        </div>
        <div class="device-settings-row">
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px">
                <input type="checkbox"
                       name="require_api_key"
                       id="require_api_key"
                       {{ if .Form.RequireAPIKey }}
                       checked
                       {{ end }}>
                <label for="require_api_key" class="device-settings-label" style="margin: 0">
                    {{ t .Localizer "Require API Key" }}
                </label>
                <small class="small-text">{{ t .Localizer "RequireAPIKeyHelp" }}</small>
            </div>
        </div>
    </div>
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Display Settings" }}</h2>
        <table class="device-settings-table">
            <tr>
                <td>
                    <label class="device-settings-label">{{ t .Localizer "Brightness Level (0 - 5)" }}</label>
                </td>
                <td>
                    <output id="brightness-output">{{ if .Form.Brightness }}{{ .Form.Brightness }}{{ else }}3{{ end }}</output>
                    <input type="hidden"
                           name="brightness"
                           id="brightness"
                           value="{{ if .Form.Brightness }}{{ .Form.Brightness }}{{ else }}3{{ end }}">
                    <div class="brightness-panel" id="brightness-panel">
                        {{ range $i := seq 0 5 }}
                        <button type="button"
                                class="brightness-btn {{ if eq $.Form.Brightness $i }}active{{ end }}"
                                data-brightness="{{ $i }}"
                                onclick="setBrightnessCreate({{ $i }})">{{ $i }}</button>
                        {{ end }}
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="device-settings-section">
        <h2>{{ t .Localizer "Location & Notes" }}</h2>
        <div class="device-settings-row">
            <div>
                <label for="location_search" class="device-settings-label">{{ t .Localizer "Location" }}</label>
                <input type="text"
                       id="location_search"
                       placeholder="{{ t .Localizer "Enter a location" }}"
                       value="{{ .Form.LocationSearch }}"
                       class="device-settings-input">
                <ul id="location_results">
                </ul>
                <input type="hidden"
                       name="location"
                       id="location"
                       value='{{ .Form.LocationJSON }}'>
            </div>
            <div>
                <label for="notes" class="device-settings-label">{{ t .Localizer "Notes" }}</label>
                <input name="notes"
                       id="notes"
                       value="{{ .Form.Notes }}"
                       class="device-settings-input"
                       placeholder="{{ t .Localizer "Optional notes about this device" }}">
            </div>
        </div>
    </div>
    <input type="hidden" name="api_key" id="api_key">
    <div class="device-settings-section">
        <div class="config-management-container"
             style="display:flex;
                    align-items:center;
                    gap:8px">
            <button type="submit" class="w3-button w3-green config-management-btn">
                <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> {{ t .Localizer "Save" }}
            </button>
            <button type="button"
                    class="w3-button w3-orange config-management-btn"
                    onclick="document.getElementById('import-file').click();">
                <i class="fa-solid fa-file-import" aria-hidden="true"></i> {{ t .Localizer "Import Configuration" }}
            </button>
        </div>
    </div>
</form>
<form id="import-device-form"
      method="post"
      action="/devices/import"
      enctype="multipart/form-data"
      style="display: none">
    <input type="file"
           name="file"
           id="import-file"
           accept=".json"
           onchange="this.form.submit();">
</form>
<script>
    function slugify(str) {
        return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    }

    function getSelectedMode() {
        var radios = document.querySelectorAll('input[name="device_id_mode"]');
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) return radios[i].value;
        }
        return 'hex8';
    }

    function updateDeviceIDMode() {
        var mode = getSelectedMode();
        var deviceIdInput = document.getElementById('device_id');
        if (mode === 'from_name') {
            deviceIdInput.value = slugify(document.getElementById('name').value);
        } else {
            if (deviceIdInput.value !== '') {
                // If a custom ID was entered, keep it visible
            } else {
                deviceIdInput.value = '';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        enableLocationSearch(document.getElementById('location_search'), document.getElementById('location_results'), document.getElementById('location'), null);

        var nameInput = document.getElementById('name');
        nameInput.addEventListener('input', function() {
            if (getSelectedMode() === 'from_name') {
                document.getElementById('device_id').value = slugify(this.value);
            }
        });

        // Initialize state on page load
        var mode = getSelectedMode();
        var deviceIdInput = document.getElementById('device_id');
        if (mode === 'from_name') {
            if (nameInput.value && !deviceIdInput.value) {
                deviceIdInput.value = slugify(nameInput.value);
            }
        }
    });
</script>
{{ end }}
